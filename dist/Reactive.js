!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Reactive=t()}(this,(function(){"use strict";class e{constructor(e){this._handler=e,this._dependencies=[]}dispatch(e,t){this._handler(e,t)}resetDependencies(){this._dependencies.splice(0,this._dependencies.length)}declareDependency(e){~this._dependencies.indexOf(e)||this._dependencies.push(e)}getDependencies(){return this._dependencies.slice()}getHandler(){return this._handler}}class t{constructor(){this._structure={}}get(e){return this._recursiveGet(this._structure,e)}add(e,t){this._recursiveAdd(this._structure,e,t)}_recursiveGet(e,t){return e[t[0]]?0==t.length?[]:1==t.length?e[t[0]].works:this._recursiveGet(e[t[0]].dependencies,t.slice(1)):[]}_recursiveAdd(e,t,s){0!=t.length&&(e[t[0]]||(e[t[0]]={works:[],dependencies:{}}),1==t.length?e[t[0]].works.push(s):this._recursiveAdd(e[t[0]].dependencies,t.slice(1),s))}}return class{constructor(e,t,s=!1){this.prop={},this.computed={},this._props={},this._computeds={},this._works=[],this._tickRunning=!1,this._successiveStack=[],this._editedPropsDuringTick=[],this._editedPropsDuringWork=[],this._accessedPropsDuringWork=[],this._eventListeners=[],this._linkedPropInvalidations={},this._verbose=s,e&&Object.keys(e).forEach((t=>{const s=e[t];this.defineProp(t,s)})),t&&this.defineComputeds(t)}defineProp(e,t){if(void 0!==this._props[e])throw new Error("Prop already defined");if("symbol"==typeof e)throw new Error("Prop can't be indexed with a symbol");const s=t=>{this._isObject(t)?this._props[e]=this._createObjectProxy(t,((...t)=>{this._propAccessed(e,...t)}),((...t)=>{this._propEdited(e,...t)}),((...t)=>{this._propEdited(e,...t)})):this._props[e]=t};s(t),Object.defineProperty(this.prop,e,{get:()=>(this._propAccessed(e),this._props[e]),set:t=>(this._props[e]!==t&&(s(t),this._propEdited(e)),this._props[e])})}defineProps(e){Object.keys(e).forEach((t=>{const s=e[t];this.defineProp(t,s)}))}defineWork(t){this._verbose&&this._log("╔════ DEFINE WORK ════╗");const s=new e(t);this._works.push(s),this._dispatchWork(s),this._verbose&&this._log("╚════ DEFINE WORK ════╝")}defineWorks(e){e.forEach((e=>{this.defineWork(e)}))}defineComputed(t,s){if(void 0!==this._computeds[t])throw new Error("Computed already defined");if("function"!=typeof s)throw new Error("The second parameter should be a function");this._verbose&&this._log("╔════ DEFINE COMPUTED ════╗");const i=new e(((e,i)=>{this._computeds[t]=s(e,i)}));this._works.push(i),Object.defineProperty(this.computed,t,{get:()=>{const e=i.getDependencies(),s=this._editedPropsDuringTick;return e.filter((e=>this._propPathExistsIn(e,s))).length&&i.dispatch(this.prop,this.computed),e.forEach((e=>{this._getDeep(this.prop,e)})),this._computeds[t]},set:()=>{throw new Error("Setting a computed directly is not allowed")}}),this._dispatchWork(i),this._verbose&&this._log("╚════ DEFINE COMPUTED ════╝")}defineComputeds(e){Object.keys(e).forEach((t=>{e[t],this.defineComputed(t,e[t])}))}defineSharedProp(t,s,i){if(void 0!==this._props[s])throw new Error("Prop already defined");if("symbol"==typeof s)throw new Error("Prop can't be indexed with a symbol");this._verbose&&this._log("╔════ DEFINE EXTERNAL PROP ════╗");const r=new e((()=>{this._props[s]=t.prop[i]}));t._works.push(r),t._linkPropInvalidation(this,i,s),Object.defineProperty(this.prop,s,{get:()=>(this._propAccessed(s),this._props[s]),set:()=>{throw new Error("This is an external prop, it can't be mutated directly")}}),t._dispatchWork(r),this._verbose&&this._log("╚════ DEFINE EXTERNAL PROP ════╝")}defineSharedProps(e,t){Object.keys(t).forEach((s=>{const i=t[s];this.defineSharedProp(e,i,s)}))}defineFormProp(e,t,s){var i;const r=null!==(i=null==s?void 0:s.getter)&&void 0!==i?i:e=>e instanceof HTMLInputElement&&"checkbox"==e.getAttribute("type")?e.checked:e instanceof HTMLSelectElement&&e.getAttribute("multiple")?Array.from(e.selectedOptions).map((e=>e.value)):e.value;Object.prototype.hasOwnProperty.call(this._props,e)||this.defineProp(e,r(t));const o=()=>{t.checkValidity()&&(this.prop[e]=r(t))};(["INPUT","TEXTAREA"].includes(t.tagName)?["input","change"]:["change"]).forEach((e=>{t.addEventListener(e,o),this._eventListeners.push({element:t,eventName:e,handler:o})})),this.defineWork((()=>{(null==s?void 0:s.setter)?s.setter(t,this.prop[e]):t instanceof HTMLInputElement&&"checkbox"==t.getAttribute("type")?t.checked=!!this.prop[e]:t.value=null===this.prop[e]?"":""+this.prop[e]}))}defineFormProps(e){Object.keys(e).forEach((t=>{this.defineFormProp(t,e[t].element,e[t].accessors)}))}touch(e){"string"==typeof e||"number"==typeof e||"symbol"==typeof e?this._propEdited(e):this._propEdited(...e)}destroy(){Object.keys(this.prop).forEach((e=>delete this.prop[e])),Object.keys(this._props).forEach((e=>delete this._props[e])),this._works.splice(0,this._works.length),this._successiveStack.splice(0,this._successiveStack.length),this._editedPropsDuringTick.splice(0,this._editedPropsDuringTick.length),this._editedPropsDuringWork.splice(0,this._editedPropsDuringWork.length),this._accessedPropsDuringWork.splice(0,this._accessedPropsDuringWork.length),this._eventListeners.forEach((e=>{e.element.removeEventListener(e.eventName,e.handler)}))}_createObjectProxy(e,t,s,i,r=new Map){if(r.has(e))return r.get(e);if(Object.getPrototypeOf(e)===Object.prototype||Array.isArray(e)){const o=Array.isArray(e)?[]:{},n=(e,r,o)=>{this._isObject(o)?e[r]=this._createObjectProxy(o,t.bind(this,r),s.bind(this,r),i.bind(this,r),c):e[r]=o},h=new Proxy(o,{get:(e,s)=>(Object.prototype.hasOwnProperty.call(e,s)&&t(s),e[s]),set:(e,t,i)=>{if(i!==e[t]){const r=!Object.hasOwnProperty.call(e,t);n(e,t,i),r?s():s(t)}return!0},deleteProperty:(e,t)=>(delete e[t],i(t),!0)}),c=new Map(r);return c.set(e,h),Object.keys(e).forEach((t=>{const s=e[t];n(o,t,s)})),h}return e}_propEdited(...e){var t;this._verbose&&this._log(`${e} edited to ${this._getDeep(this._props,e)}`),this._propPathExistsIn(e,this._editedPropsDuringTick)||this._editedPropsDuringTick.push(e),this._propPathExistsIn(e,this._editedPropsDuringWork)||this._editedPropsDuringWork.push(e),this._tickRunning||this._dispatchWorks(),null===(t=this._linkedPropInvalidations[e[0]])||void 0===t||t.forEach((t=>{t.targetReactive._propEdited(t.targetPropName,...e.slice(1))}))}_propAccessed(...e){var t;this._propPathExistsIn(e,this._accessedPropsDuringWork)||this._accessedPropsDuringWork.push(e),null===(t=this._linkedPropInvalidations[e[0]])||void 0===t||t.forEach((t=>{t.targetReactive._propAccessed(t.targetPropName,...e.slice(1))}))}_linkPropInvalidation(e,t,s){var i,r;(r=this._linkedPropInvalidations)[t]||(r[t]=[]),null===(i=this._linkedPropInvalidations[t])||void 0===i||i.push({targetReactive:e,targetPropName:s})}_dispatchWorks(){this._tickRunning=!0;const e=this._editedPropsDuringTick.splice(0,this._editedPropsDuringTick.length);Object.freeze(e);const t=this._getReversedWorksDependencies();if(this._verbose&&(this._log("╔════ TICK ════╗"),this._log("Invalidated props (edited before tick)",e),this._log("Reversed dependencies",t)),this._checkLoopInStack())throw new Error("Infinite loop detected");e.forEach((e=>{const s=t.get(e);s&&s.forEach((e=>{this._dispatchWork(e)}))})),this._verbose&&this._log("╚════ TICK ════╝"),this._tickRunning=!1,this._editedPropsDuringTick.length?this._dispatchWorks():this._successiveStack.splice(0,this._successiveStack.length)}_dispatchWork(e){this._verbose&&(this._log("════ Dispatch work ════"),this._log("\n",e.getHandler())),this._accessedPropsDuringWork.splice(0,this._accessedPropsDuringWork.length),this._editedPropsDuringWork.splice(0,this._editedPropsDuringWork.length),e.dispatch(this.prop,this.computed);const t=this._accessedPropsDuringWork.splice(0,this._accessedPropsDuringWork.length),s=this._editedPropsDuringWork.splice(0,this._editedPropsDuringWork.length),i=t.filter((e=>!this._propPathExistsIn(e,s)));this._verbose&&(this._log("Accessed",t),this._log("Edited",s),this._log("Dependencies (accessed without edited)",i)),e.resetDependencies(),i.forEach((t=>e.declareDependency(t))),this._successiveStack.push(e)}_getReversedWorksDependencies(){const e=new t;return this._works.forEach((t=>{t.getDependencies().forEach((s=>{e.add(s,t)}))})),e}_checkLoopInStack(){const e=[],t={};this._successiveStack.forEach((s=>{let i=e.indexOf(s);~i||(e.push(s),i=e.length-1,t[i]=0),t[i]++}));let s=0;return Object.keys(t).forEach((e=>{t[parseInt(e)]>s&&(s=t[parseInt(e)])})),s>20}_isObject(e){return"object"==typeof e&&null!==e}_getDeep(e,t){if(1==t.length)return e[t[0]];{const s=e[t[0]];if(this._isObject(s))return this._getDeep(s,t.slice(1))}}_propPathExistsIn(e,t){let s=!1;for(let i=0;i<t.length;i++){const r=t[i];if(e.length==r.length){let t=!0;for(let s=0;s<e.length;s++)if(e[s]!==r[s]){t=!1;break}if(t){s=!0;break}}}return s}_log(...e){const t=(e,t=2)=>{const s=e.toString();return"0".repeat(Math.max(0,t-s.length))+s},s=new Date,i="["+t(s.getHours())+":"+t(s.getMinutes())+":"+t(s.getSeconds())+"."+t(s.getMilliseconds(),3)+"]";console.log.bind(this,i).apply(this,e)}}}));
